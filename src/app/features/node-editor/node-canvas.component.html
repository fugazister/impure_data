<div class="canvas-container" #canvasContainer [class.execution-mode]="!nodeEditor.isEditMode()" 
     (keydown)="onKeyDown($event)" tabindex="0">
  <!-- Execution Mode Overlay -->
  @if (!nodeEditor.isEditMode()) {
    <div class="execution-overlay">
      <div class="execution-indicator">
        <span class="execution-icon">‚ö°</span>
        <span class="execution-text">EXECUTION MODE</span>
        <span class="execution-subtitle">Read-only - editing disabled</span>
      </div>
    </div>
  }
  
  <svg 
    class="canvas-svg"
    #canvasSvg
    [attr.width]="canvasSize().width"
    [attr.height]="canvasSize().height"
    (mousedown)="onCanvasMouseDown($event)"
    (mousemove)="onCanvasMouseMove($event)"
    (mouseup)="onCanvasMouseUp($event)"
    (wheel)="onCanvasWheel($event)"
    (contextmenu)="onCanvasRightClick($event)"
  >
    <!-- Grid background -->
    <defs>
      <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/>
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grid)" />
    
    <!-- Connections -->
    <g class="connections" [attr.transform]="canvasTransform()">
      @for (connection of connections(); track connection.id) {
        <path
          [attr.d]="getConnectionPath(connection)"
          class="connection-line"
          [class.selected]="selectedConnection() === connection.id"
          (click)="selectConnection(connection.id)"
          stroke="#666"
          stroke-width="2"
          fill="none"
        />
      }
      
      <!-- Temporary connection while dragging -->
      @if (dragConnection()) {
        <path
          [attr.d]="getDragConnectionPath()"
          class="connection-line dragging"
          stroke="#007acc"
          stroke-width="2"
          fill="none"
          stroke-dasharray="5,5"
        />
      }
    </g>
    
    <!-- Nodes -->
    <g class="nodes" [attr.transform]="canvasTransform()">
      @for (node of nodes(); track node.id) {
        <g 
          class="node"
          [class.selected]="selectedNode()?.id === node.id"
          [class.editing]="editingNodeId() === node.id"
          [class.execution-mode]="!nodeEditor.isEditMode()"
          [attr.transform]="'translate(' + node.position.x + ',' + node.position.y + ')'"
          (contextmenu)="onNodeRightClick($event, node)"
        >
          <!-- Node background -->
          <rect
            class="node-background"
            [attr.width]="getNodeWidth(node)"
            [attr.height]="getNodeHeight(node)"
            [attr.fill]="getNodeColor(node)"
            rx="4"
            ry="4"
            stroke="#333"
            stroke-width="1"
          />
          
          <!-- Header area for moving (only for non-function nodes) -->
          @if (node.type !== 'function') {
            <rect
              class="node-header"
              [attr.width]="getNodeWidth(node)"
              height="30"
              fill="rgba(0,0,0,0.2)"
              rx="4"
              ry="4"
              stroke="none"
              (mousedown)="onNodeHeaderMouseDown($event, node)"
              style="cursor: move;"
            />
          }
          
          <!-- Node title (hidden for function nodes since they have their own header) -->
          @if (node.type !== 'function') {
            <text
              class="node-title"
              x="8"
              y="20"
              fill="white"
              font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
              font-size="12"
              font-weight="bold"
              style="pointer-events: none;"
            >
              {{ getNodeDisplayName(node) }}
            </text>
          }
          
          <!-- Move handle indicator -->
          <text
            class="move-indicator"
            [attr.x]="getNodeWidth(node) - 20"
            y="20"
            fill="rgba(255,255,255,0.6)"
            font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
            font-size="10"
            style="pointer-events: none; user-select: none;"
          >
            ‚ãÆ‚ãÆ
          </text>
          
          <!-- Edit hint for function nodes -->
          @if (node && node.type === 'function' && editingNodeId() !== node.id) {
            <text
              x="8"
              [attr.y]="getNodeHeight(node) - 5"
              fill="rgba(156, 39, 176, 0.7)"
              font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
              font-size="8"
              style="pointer-events: none; user-select: none;"
            >
              Click body to edit
            </text>
          }
          
          <!-- Input ports -->
          @for (input of (node.inputs || []); track input.id; let i = $index) {
            <g class="port input-port" [attr.transform]="'translate(0,' + (35 + i * 20) + ')'">
              <circle
                [attr.cx]="0"
                [attr.cy]="0"
                r="4"
                [attr.fill]="getInputPortFill(node, input)"
                [attr.stroke]="getInputPortStroke(node)"
                stroke-width="1"
                (mousedown)="onPortMouseDown($event, node.id, input.id, 'input')"
                (mouseup)="onPortMouseUp($event, node.id, input.id, 'input')"
              />
              <text
                x="8"
                y="3"
                [attr.fill]="getInputPortTextColor(node)"
                font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
                font-size="10"
              >
                {{ input.label }}
                @if (node.type === 'function' && (node.inputs || []).length > 1) {
                  <tspan fill="#ff6b6b" font-size="8"> (no connections)</tspan>
                }
              </text>
            </g>
          }
          
          <!-- Output ports -->
          @for (output of (node.outputs || []); track output.id; let i = $index) {
            <g class="port output-port" [attr.transform]="'translate(' + getNodeWidth(node) + ',' + (35 + i * 20) + ')'">
              <circle
                [attr.cx]="0"
                [attr.cy]="0"
                r="4"
                [attr.fill]="isPortConnected(node.id, output.id, 'output') ? '#007acc' : '#ccc'"
                stroke="#333"
                stroke-width="1"
                (mousedown)="onPortMouseDown($event, node.id, output.id, 'output')"
                (mouseup)="onPortMouseUp($event, node.id, output.id, 'output')"
              />
              <text
                [attr.x]="-8"
                y="3"
                fill="#333"
                font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
                font-size="10"
                text-anchor="end"
              >
                {{ output.label }}
              </text>
            </g>
          }
          
          <!-- Function Nodes with proper hierarchy -->
          @if (node && node.type === 'function') {
            <!-- Function Header Group with nested elements -->
            <g class="function-header" transform="translate(0, 0)">
              <!-- Main header background -->
              <rect
                class="function-header-bg"
                x="0"
                y="0"
                [attr.width]="getNodeWidth(node)"
                height="60"
                fill="rgba(156, 39, 176, 0.15)"
                stroke="rgba(156, 39, 176, 0.4)"
                stroke-width="1"
                rx="4"
                ry="4"
                style="cursor: move;"
                (mousedown)="onNodeHeaderMouseDown($event, node)"
              />
              
              <!-- Drag handle area (nested inside header) -->
              <g class="drag-handle-area" transform="translate(8, 8)">
                <rect
                  class="drag-handle-bg"
                  x="0"
                  y="0"
                  width="100"
                  height="16"
                  fill="rgba(156, 39, 176, 0.1)"
                  rx="2"
                  style="pointer-events: none;"
                />
                <text
                  x="4"
                  y="12"
                  fill="rgba(156, 39, 176, 0.8)"
                  font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
                  font-size="10"
                  style="pointer-events: none; user-select: none;"
                >
                  ‚ãÆ‚ãÆ‚ãÆ Drag to move
                </text>
              </g>
              
              <!-- Function name area (nested inside header) -->
              <g class="function-name-area" transform="translate(8, 25)">
                @if (editingFunctionName() === node.id) {
                  <foreignObject 
                    x="0" 
                    y="0"
                    [attr.width]="getNodeWidth(node) - 70" 
                    height="25"
                    style="pointer-events: all;"
                  >
                    <input
                      class="function-name-input editing"
                      [value]="node.functionName || ''"
                      (input)="onFunctionNameChange($event, node.id)"
                      (blur)="onFunctionNameEditEnd()"
                      (keydown)="onFunctionNameKeyDown($event)"
                      placeholder="Function name"
                      style="width: 100%; background: rgba(255,255,255,0.9); border: 1px solid #007acc; border-radius: 3px; padding: 4px; font-family: monospace; font-size: 11px;"
                      autofocus
                    />
                  </foreignObject>
                } @else {
                  <!-- Function name display background -->
                  <rect
                    class="function-name-bg"
                    x="0"
                    y="0"
                    [attr.width]="getNodeWidth(node) - 70"
                    height="25"
                    fill="rgba(255, 255, 255, 0.05)"
                    stroke="rgba(255, 255, 255, 0.1)"
                    stroke-width="1"
                    rx="3"
                    style="pointer-events: none;"
                  />
                  <!-- Function name text -->
                  <text
                    class="function-name-display"
                    x="4"
                    y="16"
                    fill="white"
                    font-family="JetBrains Mono, Fira Code, Monaco, Consolas, monospace"
                    font-size="12"
                    font-weight="bold"
                    style="pointer-events: none;"
                  >
                    {{ node.functionName || 'Unnamed Function' }}
                  </text>
                }
              </g>
              
              <!-- Control buttons area (nested inside header) -->
              <g class="control-buttons" [attr.transform]="'translate(' + (getNodeWidth(node) - 60) + ', 25)'">
                <!-- Edit function name button -->
                <g 
                  class="edit-name-btn"
                  transform="translate(0, 0)"
                  (click)="toggleFunctionNameEdit(node.id)"
                  style="cursor: pointer;"
                >
                  <rect
                    class="button-bg"
                    x="0"
                    y="0"
                    width="18"
                    height="18"
                    fill="rgba(255,255,255,0.2)"
                    stroke="rgba(255,255,255,0.4)"
                    stroke-width="1"
                    rx="3"
                  />
                  <text
                    class="button-icon"
                    x="9"
                    y="12"
                    fill="white"
                    font-size="9"
                    text-anchor="middle"
                    style="pointer-events: none;"
                  >
                    ‚úèÔ∏è
                  </text>
                </g>
                
                <!-- Edit arguments button -->
                <g 
                  class="edit-args-btn"
                  transform="translate(25, 0)"
                  (click)="toggleArgumentsEdit(node.id)"
                  style="cursor: pointer;"
                >
                  <rect
                    class="button-bg"
                    x="0"
                    y="0"
                    width="18"
                    height="18"
                    fill="rgba(255,255,255,0.2)"
                    stroke="rgba(255,255,255,0.4)"
                    stroke-width="1"
                    rx="3"
                  />
                  <text
                    class="button-icon"
                    x="9"
                    y="12"
                    fill="white"
                    font-size="8"
                    text-anchor="middle"
                    style="pointer-events: none;"
                  >
                    ‚öôÔ∏è
                  </text>
                </g>
              </g> <!-- Close control-buttons group -->
            </g> <!-- Close function-header group -->
            
            <!-- Function body area (nested structure) -->
            <g class="function-body" [attr.transform]="'translate(0, ' + (getCodeEditorY(node) - 5) + ')'">
              <!-- Body background -->
              <rect
                class="function-body-bg"
                x="0"
                y="0"
                [attr.width]="getNodeWidth(node)"
                [attr.height]="editingNodeId() === node.id ? 130 : 70"
                fill="rgba(33, 150, 243, 0.05)"
                stroke="rgba(156, 39, 176, 0.3)"
                stroke-width="1"
                stroke-dasharray="2,2"
                rx="4"
                ry="4"
              />
              
              <!-- Interactive overlay for body clicks -->
              <rect
                class="node-body-edit-area"
                x="0"
                y="0"
                [attr.width]="getNodeWidth(node)"
                [attr.height]="editingNodeId() === node.id ? 130 : 70"
                fill="transparent"
                (click)="onNodeBodyClick($event, node)"
                (mousedown)="onBodyAreaMouseDown($event, node)"
                style="cursor: text; pointer-events: all;"
              />
              
              <!-- Argument editing interface (nested inside body) -->
              @if (editingArguments() === node.id) {
                <g class="arguments-editor-wrapper" transform="translate(8, -55)">
                  <rect
                    class="arguments-editor-bg"
                    x="0"
                    y="0"
                    [attr.width]="getNodeWidth(node) - 16"
                    height="100"
                    fill="rgba(0,0,0,0.8)"
                    stroke="#444"
                    stroke-width="1"
                    rx="4"
                  />
                  <foreignObject 
                    x="0" 
                    y="0"
                    [attr.width]="getNodeWidth(node) - 16" 
                    height="100"
                    style="pointer-events: all;"
                  >
                    <div class="arguments-editor" style="padding: 8px;">
                      <div style="color: #ccc; font-size: 12px; margin-bottom: 8px; font-family: monospace;">Arguments:</div>
                      @for (input of (node.inputs || []); track input.id; let i = $index) {
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                          <span style="color: #888; font-size: 10px; width: 15px;">{{ i + 1 }}.</span>
                          <input
                            [value]="input.label"
                            (input)="onArgumentNameChange($event, node.id, i)"
                            placeholder="arg{{ i + 1 }}"
                            style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid #666; border-radius: 3px; padding: 4px; color: white; font-family: monospace; font-size: 11px;"
                          />
                          <button 
                            type="button"
                            (click)="removeArgument(node.id, i)"
                            [disabled]="(node.inputs || []).length <= 1"
                            style="background: #f44336; color: white; border: none; border-radius: 3px; width: 18px; height: 18px; font-size: 10px; cursor: pointer;"
                            title="Remove argument"
                          >√ó</button>
                        </div>
                      }
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button 
                          type="button"
                          (click)="addArgument(node.id)"
                          style="background: #4CAF50; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 11px; cursor: pointer;"
                        >+ Add Argument</button>
                        <button 
                          type="button"
                          (click)="closeArgumentsEdit()"
                          style="background: #666; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 11px; cursor: pointer;"
                        >Done</button>
                      </div>
                    </div>
                  </foreignObject>
                </g>
              }
              
              <!-- Code editor area (nested inside body) -->
              <g class="code-editor-area" transform="translate(8, 5)">
                <!-- Code editor background -->
                <rect
                  class="code-editor-bg"
                  x="0"
                  y="0"
                  [attr.width]="getNodeWidth(node) - 16"
                  [attr.height]="editingNodeId() === node.id ? 120 : 60"
                  fill="rgba(0, 0, 0, 0.3)"
                  stroke="rgba(255, 255, 255, 0.1)"
                  stroke-width="1"
                  rx="3"
                  style="pointer-events: none;"
                />
                
                <!-- Function Code Editor -->
                <foreignObject 
                  x="0" 
                  y="0"
                  [attr.width]="getNodeWidth(node) - 16" 
                  [attr.height]="editingNodeId() === node.id ? 120 : 60"
                  style="pointer-events: none;"
                >
                  <textarea
                    #codeEditor
                    class="code-editor"
                    [class.editing]="editingNodeId() === node.id"
                    [value]="node.customCode || ''"
                    (input)="onCodeChange($event, node.id)"
                    (blur)="onEditorBlur($event)"
                    (keydown)="onCodeEditorKeyDown($event)"
                    (click)="onTextAreaClick($event, node)"
                    [readonly]="editingNodeId() !== node.id"
                    placeholder=""
                    [attr.autofocus]="editingNodeId() === node.id ? true : null"
                    [style.pointer-events]="editingNodeId() === node.id ? 'all' : 'none'"
                  ></textarea>
                </foreignObject>
              </g>
            </g> <!-- Close function-body group -->
          } <!-- Close function node condition -->
        </g>
      }
    </g>
  </svg>
  
  <!-- Context Menu -->
  @if (contextMenu().visible) {
    <div 
      class="context-menu"
      [style.left.px]="contextMenu().x"
      [style.top.px]="contextMenu().y"
    >
      <!-- Node-specific menu (when right-clicking on a node) -->
      @if (contextMenu().nodeId) {
        <div class="context-menu-item" (click)="deleteNode(contextMenu().nodeId!)">
          <span class="icon">üóëÔ∏è</span>
          <span class="label">Delete Node</span>
        </div>
      } @else {
        <!-- Canvas menu (when right-clicking on empty canvas) -->
        <div class="context-menu-item" (click)="createFunctionNode()">
          <span class="icon">‚ö°</span>
          <span class="label">Function Block</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" (click)="createTriggerNode('trigger.document')">
          <span class="icon">üìÑ</span>
          <span class="label">Document Trigger</span>
        </div>
        <div class="context-menu-item" (click)="createTriggerNode('trigger.bang')">
          <span class="icon">üí•</span>
          <span class="label">Bang Trigger</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" (click)="createDOMNode('dom.querySelector')">
          <span class="icon">üîç</span>
          <span class="label">Query Selector</span>
        </div>
        <div class="context-menu-item" (click)="createDOMNode('dom.innerHTML')">
          <span class="icon">üìù</span>
          <span class="label">Set innerHTML</span>
        </div>
        <div class="context-menu-item" (click)="createDOMNode('dom.createElement')">
          <span class="icon">‚ûï</span>
          <span class="label">Create Element</span>
        </div>
      }
    </div>
  }
</div>